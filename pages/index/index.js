import Toast from 'tdesign-miniprogram/toast';
import ActionSheet from 'tdesign-miniprogram/action-sheet/index';
import { svg2imgdata, formatTime } from '../../utils/util'
Page({
  data: {
    list: [],
    rightArrow: svg2imgdata('<svg t="1714015044177" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3912" width="200" height="200"><path d="M768 511.957333c0.0512-3.456-0.546133-6.741333-1.314133-10.112-0.341333-1.450667-0.554667-2.858667-1.066667-4.266666-2.304-6.954667-5.717333-13.525333-11.477333-18.688l-427.178667-382.762667a42.461867 42.461867 0 0 0-60.288 3.754667c-15.573333 17.834667-13.909333 45.312 3.712 61.098666l391.722667 350.976-391.722667 351.061334c-17.621333 15.786667-19.285333 43.264-3.712 61.098666a42.461867 42.461867 0 0 0 60.288 3.754667l427.178667-382.848c5.76-5.162667 9.173333-11.733333 11.477333-18.688 0.512-1.408 0.725333-2.816 1.066667-4.266667 0.768-3.370667 1.365333-6.656 1.322666-10.112" fill="#515152" p-id="3913"></path></svg>'),
    leftTopLogo: svg2imgdata('<svg t="1715998473069" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2969" width="200" height="200"><path d="M380.565633 84.168898C391.492953 73.241577 412.883938 64.383234 428.328892 64.383234L596.182087 64.383234C611.633685 64.383234 633.010015 73.233567 643.945345 84.168898L680.111776 120.335329 344.399202 120.335329 380.565633 84.168898Z" fill="#FC5143" p-id="2970"></path><path d="M875.944112 176.287425C891.394856 176.287425 903.92016 163.762122 903.92016 148.311377 903.92016 132.860633 891.394856 120.335329 875.944112 120.335329L148.566866 120.335329C133.116122 120.335329 120.590818 132.860633 120.590818 148.311377 120.590818 163.762122 133.116122 176.287425 148.566866 176.287425L875.944112 176.287425Z" fill="#FC5143" p-id="2971"></path><path d="M180.539492 232.239521 180.254748 228.253099 228.640985 176.287425 232.637564 176.287425 280.347765 844.230242C282.63628 876.269454 312.053012 903.664671 344.377659 903.664671L680.133319 903.664671C712.845805 903.664671 741.848496 876.636282 744.163214 844.230242L791.873414 176.287425 795.869993 176.287425 844.25623 228.253099 843.971486 232.239521 180.539492 232.239521ZM847.968064 176.287425 799.973118 848.216664C795.578506 909.741242 742.362215 959.616766 680.133319 959.616766L344.377659 959.616766C282.586578 959.616766 228.909839 909.424372 224.53786 848.216664L176.542914 176.287425 847.968064 176.287425Z" fill="#FC5143" p-id="2972"></path><path d="M484.279441 763.784431C484.279441 779.235176 496.804744 791.760479 512.255489 791.760479 527.706234 791.760479 540.231537 779.235176 540.231537 763.784431L540.231537 372.11976C540.231537 356.669016 527.706234 344.143713 512.255489 344.143713 496.804744 344.143713 484.279441 356.669016 484.279441 372.11976L484.279441 763.784431Z" fill="#FC5143" p-id="2973"></path><path d="M607.198225 760.600957C605.851604 775.992907 617.237593 789.562199 632.629543 790.908821 648.021493 792.255442 661.590785 780.869453 662.937406 765.477503L697.073232 375.303235C698.419853 359.911285 687.033864 346.341992 671.641914 344.995371 656.249965 343.64875 642.680672 355.034739 641.334051 370.426688L607.198225 760.600957Z" fill="#FC5143" p-id="2974"></path><path d="M361.573572 765.477503C362.920193 780.869453 376.489486 792.255442 391.881435 790.908821 407.273385 789.562199 418.659374 775.992907 417.312753 760.600957L383.176927 370.426688C381.830306 355.034739 368.261013 343.64875 352.869064 344.995371 337.477114 346.341992 326.091125 359.911285 327.437746 375.303235L361.573572 765.477503Z" fill="#FC5143" p-id="2975"></path></svg>'),
  },
  onShow(){
    this.init();
  },
  init(){
    wx.getStorageInfo({
      success: (res) => {
        const { keys } = res;
        wx.batchGetStorage({
          keyList: keys,
          success: (res) => {
            const { dataList } = res;
            const list = [];
            const values = {};
            keys.forEach((v, idx) => {
              const data = dataList[idx]
              const id = v.split(".").pop();
              if (v.includes("questionnaire.")){
                data.id = id;
                data.dateText = formatTime(data.date, 'YYYY年MM月DD日 HH:mm');
                list.push(data);
                if(!values.hasOwnProperty(id))values[id] = [];
              }else if (v.includes("data.")){
                values[id] = data.sort((a,b) => b.time - a.time);
              }
            })
            this.setData({
              list: list.sort((a,b) => b.date - a.date),
              data: values,
            })
          }
        })
      },
      fail: (err) => {
        this.showToast(`获取历史问卷失败 ${err.errMsg}`)
      }
    })
  },
  del(idx){
    const { list } = this.data;
    const id = list[idx].id
    wx.showModal({
      title: '是否删除问卷',
      content: `标题：${list[idx].title}`,
      confirmColor: '#c55347',
      complete: (res) => {
        if (res.confirm) {
          wx.removeStorage({
            key: `questionnaire.${id}`,
            success: () => {
              list.splice(idx,1);
              this.setData({list});
              this.showToast("删除成功", status="success")
              wx.removeStorage({key: `data.${id}`,})
            },
            fail: (err) => {
              this.showToast(`删除失败 ${err.errMsg}`);
            }
          })
        }
      }
    })
  },
  handleSelected(e){
    const { index, selected: { idx } } = e.detail;
    [this.del, function(){this.navTo(`../create-questionnaire/index?id=${this.data.list[idx].id}`)}, function(){this.navTo(`../list/index?id=${this.data.list[idx].id}`)}, function(){this.navTo(`../questionnaire/index?id=${this.data.list[idx].id}`)}][index].call(this, idx);
  },
  select(e){
    const { idx } = e.currentTarget.dataset;
    ActionSheet.show({
      theme: "grid",
      selector: '#t-action-sheet',
      items: [
        {
          label: '删除',
          image: svg2imgdata('<svg t="1718611856564" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5413" width="200" height="200"><path d="M510.6176 324.0448m-250.5216 0a250.5216 250.5216 0 1 0 501.0432 0 250.5216 250.5216 0 1 0-501.0432 0Z" fill="#F9B900" p-id="5414"></path><path d="M510.6176 324.0448m-200.6528 0a200.6528 200.6528 0 1 0 401.3056 0 200.6528 200.6528 0 1 0-401.3056 0Z" fill="#F9C633" p-id="5415"></path><path d="M510.6176 324.0448m-153.8048 0a153.8048 153.8048 0 1 0 307.6096 0 153.8048 153.8048 0 1 0-307.6096 0Z" fill="#FFCA61" p-id="5416"></path><path d="M741.0176 952.0128h-460.8c-61.7472 0-111.7696-50.0224-111.7696-111.7696V324.0448h684.3392V840.192c0 61.7472-50.0224 111.8208-111.7696 111.8208z" fill="#6ACC36" p-id="5417"></path><path d="M692.8384 892.416H328.3968c-61.7472 0-111.7696-50.0224-111.7696-111.7696V352.9216h587.9808v427.7248c0 61.7472-50.0224 111.7696-111.7696 111.7696z" fill="#6ED541" p-id="5418"></path><path d="M648.0384 851.3536H373.1968c-61.7472 0-111.7696-50.0224-111.7696-111.7696V334.2848h498.432v405.248c-0.0512 61.7472-50.0736 111.8208-111.8208 111.8208z" fill="#76DD45" p-id="5419"></path><path d="M583.7824 784.6912H437.4528c-61.7472 0-111.7696-50.0224-111.7696-111.7696v-324.608h369.8688v324.608c0 61.696-50.0224 111.7696-111.7696 111.7696z" fill="#8AE555" p-id="5420"></path><path d="M894.4128 375.808H126.8224c-34.4576 0-62.3616-28.672-62.3616-64s27.904-64 62.3616-64h767.5904c34.4576 0 62.3616 28.672 62.3616 64s-27.904 64-62.3616 64z" fill="#6ACC36" p-id="5421"></path><path d="M894.4128 352.768H126.8224c-22.016 0-39.936-18.3296-39.936-40.96s17.8688-40.96 39.936-40.96h767.5904c22.016 0 39.936 18.3296 39.936 40.96s-17.8688 40.96-39.936 40.96z" fill="#6ED541" p-id="5422"></path><path d="M894.4128 332.288H126.8224c-11.008 0-19.968-9.1648-19.968-20.48s8.96-20.48 19.968-20.48h767.5904c11.008 0 19.968 9.1648 19.968 20.48s-8.96 20.48-19.968 20.48z" fill="#9CEF65" p-id="5423"></path><path d="M364.3904 425.0112c-36.7104 0-66.56 29.8496-66.56 66.56v265.216c0 36.7104 29.8496 66.56 66.56 66.56s66.56-29.8496 66.56-66.56v-265.216c0-36.7104-29.8496-66.56-66.56-66.56zM514.8672 425.0112c-36.7104 0-66.56 29.8496-66.56 66.56v265.216c0 36.7104 29.8496 66.56 66.56 66.56s66.56-29.8496 66.56-66.56v-265.216c0-36.7104-29.8496-66.56-66.56-66.56zM665.3952 425.0112c-36.7104 0-66.56 29.8496-66.56 66.56v265.216c0 36.7104 29.8496 66.56 66.56 66.56s66.56-29.8496 66.56-66.56v-265.216c0-36.7104-29.8496-66.56-66.56-66.56z" fill="#6ACC36" p-id="5424"></path><path d="M364.3904 802.8672a46.08 46.08 0 0 1-46.08-46.08v-265.216a46.08 46.08 0 0 1 92.16 0v265.216a46.08 46.08 0 0 1-46.08 46.08zM514.8672 802.8672a46.08 46.08 0 0 1-46.08-46.08v-265.216a46.08 46.08 0 0 1 92.16 0v265.216a46.08 46.08 0 0 1-46.08 46.08zM665.3952 802.8672a46.08 46.08 0 0 1-46.08-46.08v-265.216a46.08 46.08 0 0 1 92.16 0v265.216a46.08 46.08 0 0 1-46.08 46.08z" fill="#F9B900" p-id="5425"></path><path d="M364.3904 784.9472c-15.5648 0-28.16-12.5952-28.16-28.16v-265.216c0-15.5648 12.5952-28.16 28.16-28.16s28.16 12.5952 28.16 28.16v265.216c0 15.5648-12.5952 28.16-28.16 28.16zM514.8672 784.9472c-15.5648 0-28.16-12.5952-28.16-28.16v-265.216c0-15.5648 12.5952-28.16 28.16-28.16s28.16 12.5952 28.16 28.16v265.216c0 15.5648-12.5952 28.16-28.16 28.16zM665.3952 784.9472c-15.5648 0-28.16-12.5952-28.16-28.16v-265.216c0-15.5648 12.5952-28.16 28.16-28.16s28.16 12.5952 28.16 28.16v265.216c0 15.5648-12.6464 28.16-28.16 28.16z" fill="#F9C633" p-id="5426"></path><path d="M364.3904 769.5872a12.8 12.8 0 0 1-12.8-12.8v-265.216a12.8 12.8 0 0 1 25.6 0v265.216a12.8 12.8 0 0 1-12.8 12.8zM514.8672 769.5872a12.8 12.8 0 0 1-12.8-12.8v-265.216a12.8 12.8 0 0 1 25.6 0v265.216a12.8 12.8 0 0 1-12.8 12.8zM665.3952 769.5872a12.8 12.8 0 0 1-12.8-12.8v-265.216a12.8 12.8 0 0 1 25.6 0v265.216a12.8 12.8 0 0 1-12.8 12.8z" fill="#FFD68D" p-id="5427"></path></svg>'),
          idx,
        },
        {
          label: '编辑',
          image: svg2imgdata('<svg t="1718611910625" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9804" width="200" height="200"><path d="M816.1 910.8H159.6c-40.5 0-73.4-30.9-73.4-68.8V202c0-37.9 32.9-68.8 73.4-68.8h335c10.9 0 19.8 8.9 19.8 19.8s-8.9 19.8-19.8 19.8h-335c-18.6 0-33.8 13.1-33.8 29.2v640c0 16.1 15.2 29.2 33.8 29.2h656.5c18.6 0 33.8-13.1 33.8-29.2l-1.5-303.8c-0.1-10.9 8.8-19.8 19.7-19.9 11 0 19.8 8.8 19.9 19.7l1.5 303.9c0 38-32.9 68.9-73.4 68.9z" fill="#231815" p-id="9805"></path><path d="M745.5 532.9l1 205.8c0 18.3-16.3 33.2-36.3 33.2H265.5c-20.1 0-36.3-14.9-36.3-33.2V305.3c0-18.3 16.3-33.2 36.3-33.2h226.9" fill="#00c59e" p-id="9806"></path><path d="M475.8 562c-5.2 0-10.4-2.1-14.3-6.1L376.7 467c-3.7-3.9-5.7-9.1-5.5-14.5 0.2-5.4 2.6-10.4 6.7-14l347.6-307.3c8-7 20.1-6.5 27.4 1.2l84.8 88.9c3.7 3.9 5.7 9.1 5.5 14.5-0.2 5.4-2.6 10.4-6.7 14L488.9 557.1c-3.7 3.3-8.4 4.9-13.1 4.9z m-56.3-107.5l57.5 60.2 317.9-281-57.5-60.2-317.9 281z" fill="#231815" p-id="9807"></path><path d="M824.2 254.1c-5.2 0-10.4-2.1-14.3-6.1L725 159.1c-3.7-3.9-5.7-9.1-5.5-14.5 0.2-5.4 2.6-10.4 6.7-14l52.6-46.5c8-7 20.1-6.5 27.4 1.2l84.8 88.9c3.7 3.9 5.7 9.1 5.5 14.5-0.2 5.4-2.6 10.4-6.7 14l-52.6 46.5c-3.7 3.3-8.4 4.9-13 4.9z m-56.3-107.5l57.5 60.2 22.9-20.2-57.5-60.2-22.9 20.2zM332.6 606.7c-5.5 0-10.9-2.3-14.8-6.6-5.2-5.8-6.5-14.1-3.4-21.2l59-134.1c2.7-6.1 8.2-10.4 14.7-11.5 6.5-1.1 13.2 1 17.7 5.8l84.8 88.9c4.7 4.9 6.6 12 4.8 18.6-1.7 6.6-6.7 11.9-13.2 13.9l-143.8 45.1c-1.8 0.8-3.8 1.1-5.8 1.1zM397.7 488l-29.5 66.9 71.8-22.5-42.3-44.4zM724.2 647.9H595.6c-10.7 0-19.4-8.7-19.4-19.4v-0.9c0-10.7 8.7-19.4 19.4-19.4h128.6c10.7 0 19.4 8.7 19.4 19.4v0.9c0 10.7-8.7 19.4-19.4 19.4zM752.5 780.2H223.2c-10 0-18.2-8.2-18.2-18.2v-3.2c0-10 8.2-18.2 18.2-18.2h529.3c10 0 18.2 8.2 18.2 18.2v3.2c0 10-8.2 18.2-18.2 18.2z" fill="#231815" p-id="9808"></path></svg>'),
          idx,
        },
        {
          label: '详细数据',
          image: svg2imgdata('<svg t="1718611935836" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10932" width="200" height="200"><path d="M0 0h1024v1024H0V0z" fill="#202425" opacity=".01" p-id="10933"></path><path d="M136.533333 68.266667a68.266667 68.266667 0 0 0-68.266666 68.266666v428.305067a17.066667 17.066667 0 0 0 28.842666 12.356267l237.738667-226.440534a34.133333 34.133333 0 0 1 42.496-3.6864l268.288 178.858667a17.066667 17.066667 0 0 0 22.766933-3.447467L951.978667 171.4176A17.066667 17.066667 0 0 0 955.733333 160.699733V136.533333a68.266667 68.266667 0 0 0-68.266666-68.266666H136.533333z m819.2 255.3856a17.066667 17.066667 0 0 0-30.344533-10.717867l-221.866667 274.705067a17.066667 17.066667 0 0 0-3.7888 10.717866v340.309334a17.066667 17.066667 0 0 0 17.066667 17.066666h170.666667a68.266667 68.266667 0 0 0 68.266666-68.266666V323.652267zM614.4 955.733333a17.066667 17.066667 0 0 0 17.066667-17.066666v-330.990934a17.066667 17.066667 0 0 0-7.611734-14.199466l-204.8-136.533334a17.066667 17.066667 0 0 0-26.5216 14.199467V938.666667a17.066667 17.066667 0 0 0 17.066667 17.066666h204.8z m-307.2 0a17.066667 17.066667 0 0 0 17.066667-17.066666v-443.733334a17.066667 17.066667 0 0 0-28.842667-12.356266l-221.866667 211.285333a17.066667 17.066667 0 0 0-5.290666 12.3904V887.466667a68.266667 68.266667 0 0 0 68.266666 68.266666h170.666667z" fill="#FFAA44" p-id="10934"></path><path d="M73.557333 693.8624a17.066667 17.066667 0 0 0-5.290666 12.3904V887.466667a68.266667 68.266667 0 0 0 68.266666 68.266666h170.666667a17.066667 17.066667 0 0 0 17.066667-17.066666v-443.733334a17.066667 17.066667 0 0 0-28.842667-12.356266l-221.866667 211.285333zM392.533333 938.666667a17.066667 17.066667 0 0 0 17.066667 17.066666h204.8a17.066667 17.066667 0 0 0 17.066667-17.066666v-330.990934a17.066667 17.066667 0 0 0-7.611734-14.199466l-204.8-136.533334a17.066667 17.066667 0 0 0-26.5216 14.199467V938.666667z m307.2 0a17.066667 17.066667 0 0 0 17.066667 17.066666h170.666667a68.266667 68.266667 0 0 0 68.266666-68.266666V323.6864a17.066667 17.066667 0 0 0-30.344533-10.752l-221.866667 274.705067a17.066667 17.066667 0 0 0-3.7888 10.717866v340.309334z" fill="#11AA66" p-id="10935"></path></svg>'),
          idx,
        },
        {
          label: '填写问卷',
          image: svg2imgdata('<svg t="1718611971195" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11958" width="200" height="200"><path d="M622.848 68.608H179.456c-30.592 0-55.424 24.832-55.424 55.424v776.064c0 30.592 24.832 55.424 55.424 55.424h665.088c30.592 0 55.424-24.832 55.424-55.424v-554.24L622.848 68.608z" fill="#4DB222" p-id="11959"></path><path d="M622.848 68.608v221.696c0 30.592 24.832 55.424 55.424 55.424h221.696L622.848 68.608z" fill="#73C94B" p-id="11960"></path><path d="M678.272 345.728l221.696 221.696V345.728H678.272z" fill="#4BA521" p-id="11961"></path><path d="M484.224 484.352h249.472V595.2H484.224v-110.848z m-193.92 0h166.272V595.2H290.304v-110.848z m193.92 138.496h249.472v83.2H484.224v-83.2z m-193.92 0h166.272v83.2H290.304v-83.2z m193.92 110.848h249.472v83.2H484.224v-83.2z m-193.92 0h166.272v83.2H290.304v-83.2z" fill="#FFFFFF" p-id="11962"></path></svg>'),
          idx,
        },
      ],
    });
  },
  showToast(msg, status='error'){
    Toast({
      context: this,
      selector: '#t-toast',
      message: msg||"系统错误",
      theme: status,
      direction: 'column',
    });
  },
  clearStorage(){
    wx.showModal({
      title: '是否清空问卷',
      confirmColor: '#c55347',
      complete: (res) => {
        if (res.confirm) {
          wx.clearStorage({
            success: () => {
              this.setData({
                list: [],
                data: {},
              })
              this.showToast("清空成功", "success");
            },
            fail: (err) => {
              this.showToast(err.errMsg);
            }
          });
        }
      }
    })
  },
  navTo(e){
    const url = e?.currentTarget?.dataset?.url||e
    wx.navigateTo({
      url,
      fail: (res) => {
        this.showToast(res.errMsg)
      },
    })
  },
  shareConfig: {
    title: "问卷",
  },
  onShareAppMessage(){
    return this.shareConfig;
  },
  onAddToFavorites(){
    return this.shareConfig;
  },
  onShareTimeline(){
    return this.shareConfig;
  },
  onUnload(){
    for (let k in this.data){
      this.data[k] = null
    }
    this.data = null;
  },
})
